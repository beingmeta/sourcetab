#!/bin/sh
PREFIX=@PREFIX@
UPSOURCE=@LIBDIR@
STATEDIR=@RUNDIR@
LOGDIR=@LOGDIR@
AWK=@AWK@
CONFIG=${UPSOURCE_CONFIG:-@ETC@/upsource.d/config}

sourcetab_command()
{
	grep -v "^\s*$" | grep -v "^[ 	]*[#;]" | ${AWK} -f @LIBDIR@/sourcetab.awk;
}
generate_upsource_commands()
{
    ARG=$1
    echo "export SSH_USER SSH_KEY OWNER GROUP SOURCETAB SOURCETABD;";
    echo "export PREFIX=@PREFIX@;";
    echo "export UPSOURCE=@LIBDIR@;";
    echo "export STATEDIR=@RUNDIR@;";
    echo "export ETC=@ETC@;";
    if test -d ${ARG}; then
	if test -f ${ARG}/config; then
	    cat ${ARG}/config; fi; 
	for tab in ${ARG}/*.srctab; do
	    if test -f ${tab}; then
		cat ${tab} | sourcetab_command;
	    fi;
	done;
    elif test -f ${ARG}; then 
	DIRNAME=`dirname ${ARG}`
	if test -f ${DIRNAME}/.upsource; then
	    cat ${DIRNAME}/.upsource; 
	elif test -f ~/.upsource; then
	    cat ~/.upsource; ;
	fi
	cat ${ARG} | sourcetab_command;
    else
	echo "usage: upsource [sourcetab file or directory]";
	exit;
    fi
}

for pre in @LIBDIR@/handlers/*.pre; do
    if test -x ${pre}; then ${pre}; fi; done

# With no arguments, process the system upsource.d directory
if test $# -eq 0; then
    generate_upsource_commands @ETC@/upsource.d | bash;
else 
    for tab in $*; do \
      generate_upsource_commands ${tab} | bash; 
    done;
fi

for run in @RUNDIR@/*.post; do
    if test -f ${run}; then ${run}; fi; done

for post in @LIBDIR@/handlers/*.post; do
    if test -x ${post}; then ${post}; fi; done

