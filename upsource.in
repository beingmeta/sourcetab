#!/bin/sh
if test $# -eq 0; then
    SOURCETAB=@ETC@/srctab;
    SOURCETABD=@ETC@/sourcetab.d;
else
    SOURCETAB=$1
    SOURCETABD=$2
fi
PREFIX=@PREFIX@
UPSOURCE=@LIBDIR@
STATEDIR=@RUNDIR@/upsource
AWK=@AWK@

sourcetab_command()
{
	grep -v "^\s*$" | grep -v "^[ 	]*[#;]" | ${AWK} -f @LIBDIR@/sourcetab.awk;
}
generate_upsource_commands()
{
    if test -f @ETC@/upsource.d/config; then cat @ETC@/upsource.d/config; fi;
    echo "export SSH_USER SSH_KEY OWNER GROUP SOURCETAB SOURCETABD";
    echo "export PREFIX UPSOURCE STATEDIR";
    if test -f ${SOURCETAB}; then cat ${SOURCETAB} | sourcetab_command; fi;
    if test ! -z "${SOURCETABD}" && test -d ${SOURCETABD}; then
	for tab in ${SOURCETABD}/*.srctab; do
	    cat ${tab} | sourcetab_command; 
	done;
    fi;
}

for pre in @LIBDIR@/handlers/*.pre; do
    if test -x ${pre}; then ${pre}; fi; done

generate_upsource_commands | bash

for run in @RUNDIR@/*.post; do
    if test -f ${run}; then ${run}; fi; done

for post in @LIBDIR@/handlers/*.post; do
    if test -x ${post}; then ${post}; fi; done

