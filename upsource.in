#!/bin/sh
PREFIX=@PREFIX@
UPSOURCE=@LIBDIR@
STATEDIR=@RUNDIR@/upsource
AWK=@AWK@
CONFIG=${UPSOURCE_CONFIG:-@ETC@/upsource.d/config}

sourcetab_command()
{
	grep -v "^\s*$" | grep -v "^[ 	]*[#;]" | ${AWK} -f @LIBDIR@/sourcetab.awk;
}
generate_upsource_commands()
{
    ARG=$1
    if test -f @ETC@/upsource.d/config; then cat @ETC@/upsource.d/config; fi;
    echo "export SSH_USER SSH_KEY OWNER GROUP SOURCETAB SOURCETABD";
    echo "export PREFIX UPSOURCE STATEDIR";
    if test -d ${ARG}; then
	for tab in ${SOURCETABD}/*.srctab; do
	    if test -f ${tab}; then
		cat ${tab} | sourcetab_command;
	    fi;
	done;
    elif test -f ${ARG}; then 
	cat ${ARG} | sourcetab_command;
    else
	echo "upsource usage: [sourcetab file or directory]";
	exit;
    fi
}

for pre in @LIBDIR@/handlers/*.pre; do
    if test -x ${pre}; then ${pre}; fi; done

if test $# -eq 0; then
    generate_upsource_commands | bash;
else 
    generate_upsource_commands $1 | bash;
    if test $# -neq 1; then 
	shift;
	echo "Extraneous arguments:" $*;
    fi
fi

for run in @RUNDIR@/*.post; do
    if test -f ${run}; then ${run}; fi; done

for post in @LIBDIR@/handlers/*.post; do
    if test -x ${post}; then ${post}; fi; done

